{% extends "base.html" %}

{% block title %}Cricket Score API - Главная{% endblock %}

{% block content %}
<div class="header">
    <h1><i class="fas fa-home"></i> Cricket Score API</h1>
    <p>Веб-приложение для подсчета очков в крикете с использованием веб-скрапинга и базы данных</p>
    <p class="subtitle">Курсовой проект по дисциплине "Разработка ПО" | ИСТ-11</p>
</div>

<div class="dashboard">
    <div class="stats">
        <div class="stat-card">
            <h3><i class="fas fa-baseball-ball"></i> Матчи</h3>
            <p class="stat-number">{{ matches_count }}</p>
            <a href="/matches" class="btn">Просмотреть</a>
        </div>
        
        <div class="stat-card">
            <h3><i class="fas fa-users"></i> Игроки</h3>
            <p class="stat-number">{{ players_count }}</p>
            <a href="/players" class="btn">Просмотреть</a>
        </div>
        
        <div class="stat-card">
            <h3><i class="fas fa-calculator"></i> Расчеты</h3>
            <p class="stat-number">{{ calculations_count }}</p>
            <a href="/calculate" class="btn">Рассчитать</a>
        </div>
        
        <div class="stat-card">
            <h3><i class="fas fa-database"></i> База данных</h3>
            <p class="stat-number">SQLite</p>
            <a href="/admin" class="btn">Управление</a>
        </div>
    </div>
</div>

<div class="features">
    <h2><i class="fas fa-check-circle"></i> Функциональность проекта</h2>
    
    <div class="feature-list">
        <div class="feature">
            <i class="fas fa-database"></i>
            <h3>База данных SQLite</h3>
            <p>Полноценная работа с БД (CRUD операции, сложные запросы, JOIN)</p>
        </div>
        
        <div class="feature">
            <i class="fas fa-spider"></i>
            <h3>Веб-скрапинг</h3>
            <p>Автоматический сбор данных о матчах с внешних источников</p>
        </div>
        
        <div class="feature">
            <i class="fas fa-calculator"></i>
            <h3>Расчет очков</h3>
            <p>Автоматический подсчет очков по правилам крикета</p>
        </div>
        
        <div class="feature">
            <i class="fas fa-code"></i>
            <h3>REST API</h3>
            <p>Полноценный API для интеграции с другими системами</p>
        </div>
    </div>
</div>

<div class="api-docs">
    <h2><i class="fas fa-book"></i> Примеры использования API</h2>
    
    <div class="code-examples">
        <div class="code-block">
            <h4>Получить список матчей</h4>
            <code>GET /api/matches</code>
            <button class="btn-small" onclick="testEndpoint('/api/matches')">Проверить</button>
        </div>
        
        <div class="code-block">
            <h4>Получить игроков-отбивающих</h4>
            <code>GET /api/players?role=batsman</code>
            <button class="btn-small" onclick="testEndpoint('/api/players?role=batsman')">Проверить</button>
        </div>
        
        <div class="code-block">
            <h4>Топ боулеры</h4>
            <code>GET /api/players/top/bowler</code>
            <button class="btn-small" onclick="testEndpoint('/api/players/top/bowler')">Проверить</button>
        </div>
        
        <div class="code-block">
            <h4>Проверка работоспособности</h4>
            <code>GET /api/health</code>
            <button class="btn-small" onclick="testEndpoint('/api/health')">Проверить</button>
        </div>
    </div>
</div>

<div class="requirements">
    <h2><i class="fas fa-clipboard-check"></i> Соответствие требованиям курсовой</h2>
    
    <ul class="requirement-list">
        <li><i class="fas fa-check"></i> <strong>Лабораторная работа №2:</strong> Работа с базой данных SQLite, сложные запросы</li>
        <li><i class="fas fa-check"></i> <strong>Лабораторная работа №4:</strong> Приложение на базе Flask</li>
        <li><i class="fas fa-check"></i> <strong>Лабораторная работа №5:</strong> Веб-приложение с использованием БД</li>
        <li><i class="fas fa-check"></i> <strong>Курсовой проект:</strong> Работающий программный продукт + пояснительная записка</li>
    </ul>
</div>

<script>
<script>
// Функция для тестирования API эндпоинтов
async function testEndpoint(endpoint) {
    try {
        const response = await fetch(endpoint);
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        
        // Форматируем JSON для красивого отображения
        const formattedJson = JSON.stringify(data, null, 2);
        
        // Создаем модальное окно для отображения результата
        showApiResultModal(endpoint, formattedJson);
        
    } catch (error) {
        console.error('API Test Error:', error);
        alert(`Ошибка при тестировании API:\n${error.message}\n\nПроверьте консоль для подробностей.`);
    }
}

// Функция для отображения результатов API в модальном окне
function showApiResultModal(endpoint, data) {
    // Создаем модальное окно
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>API Response: ${endpoint}</h3>
                <span class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
            </div>
            <div class="modal-body">
                <pre>${data}</pre>
            </div>
            <div class="modal-footer">
                <button onclick="copyToClipboard('${data.replace(/'/g, "\\'")}')" class="btn-small">
                    <i class="fas fa-copy"></i> Копировать JSON
                </button>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn-small btn-secondary">
                    Закрыть
                </button>
            </div>
        </div>
    `;
    
    // Добавляем стили для модального окна
    const style = document.createElement('style');
    style.textContent = `
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header {
            background: #2a5298;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            font-weight: bold;
        }
        .modal-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .modal-body pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .modal-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            text-align: right;
        }
    `;
    
    document.head.appendChild(style);
    document.body.appendChild(modal);
}

// Функция для копирования текста в буфер обмена
function copyToClipboard(text) {
    navigator.clipboard.writeText(text)
        .then(() => {
            alert('JSON скопирован в буфер обмена!');
        })
        .catch(err => {
            console.error('Ошибка копирования:', err);
            alert('Не удалось скопировать текст');
        });
}

// Загружаем статистику при загрузке страницы
async function loadStats() {
    try {
        const response = await fetch('/api/health');
        const data = await response.json();
        
        if (response.ok) {
            // Обновляем статистику на странице
            document.querySelectorAll('.stat-number')[0].textContent = data.stats.matches;
            document.querySelectorAll('.stat-number')[1].textContent = data.stats.players;
            document.querySelectorAll('.stat-number')[2].textContent = data.stats.calculations;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Запускаем при загрузке страницы
window.addEventListener('DOMContentLoaded', loadStats);
</script>

<style>
.dashboard {
    margin: 30px 0;
}

.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #2a5298;
    margin: 10px 0;
}

.feature-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.feature {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.feature i {
    font-size: 2rem;
    color: #2a5298;
    margin-bottom: 10px;
}

.code-examples {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.code-block {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    border-left: 4px solid #2a5298;
}

.code-block code {
    display: block;
    margin: 10px 0;
    padding: 10px;
    background: white;
    border-radius: 3px;
    font-family: monospace;
}

.requirement-list {
    list-style: none;
    padding: 0;
}

.requirement-list li {
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}

.requirement-list li:last-child {
    border-bottom: none;
}

.requirement-list i.fa-check {
    color: #49cc90;
    margin-right: 10px;
}
</style>
{% endblock %}
