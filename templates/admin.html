{% extends "base.html" %}

{% block title %}Admin Panel - Cricket Score API{% endblock %}

{% block content %}
<div class="header">
    <h1><i class="fas fa-cog"></i> Админ-панель</h1>
    <p>Управление базой данных и данными приложения</p>
</div>

<div class="admin-sections">
    <div class="admin-section">
        <h2><i class="fas fa-baseball-ball"></i> Управление матчами</h2>
        
        <div class="form-container">
            <h3>Добавить новый матч</h3>
            <form id="addMatchForm">
                <div class="form-group">
                    <label>Команда 1:</label>
                    <input type="text" id="team1" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Команда 2:</label>
                    <input type="text" id="team2" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Стадион:</label>
                    <input type="text" id="venue" class="form-control">
                </div>
                <div class="form-group">
                    <label>Формат:</label>
                    <select id="format" class="form-control">
                        <option value="T20 International">T20 International</option>
                        <option value="ODI">ODI</option>
                        <option value="Test Match">Test Match</option>
                        <option value="IPL T20">IPL T20</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Статус:</label>
                    <select id="status" class="form-control">
                        <option value="Scheduled">Запланирован</option>
                        <option value="Live">В прямом эфире</option>
                        <option value="Finished">Завершен</option>
                    </select>
                </div>
                <button type="submit" class="btn">Добавить матч</button>
            </form>
        </div>
        
        <div class="table-container">
            <h3>Существующие матчи</h3>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Матч</th>
                        <th>Формат</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="matchesTable">
                    {% for match in matches %}
                    <tr>
                        <td>{{ match.id }}</td>
                        <td>{{ match.team1 }} vs {{ match.team2 }}</td>
                        <td>{{ match.format }}</td>
                        <td><span class="badge badge-{{ match.status }}">{{ match.status }}</span></td>
                        <td>
                            <button class="btn-small btn-edit" onclick="editMatch({{ match.id }})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-small btn-delete" onclick="deleteMatch({{ match.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="admin-section">
        <h2><i class="fas fa-history"></i> История расчетов</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Игрок</th>
                        <th>Очки</th>
                        <th>Дата расчета</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in points_history %}
                    <tr>
                        <td>{{ record.id }}</td>
                        <td>{{ record.player.name if record.player else 'N/A' }}</td>
                        <td>{{ record.points }}</td>
                        <td>{{ record.calculation_date.strftime('%Y-%m-%d %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="database-actions">
    <h2><i class="fas fa-tools"></i> Действия с базой данных</h2>
    
    <div class="action-buttons">
        <button class="btn" onclick="scrapeMatches()">
            <i class="fas fa-spider"></i> Загрузить матчи (веб-скрапинг)
        </button>
        
        <button class="btn" onclick="resetDatabase()">
            <i class="fas fa-redo"></i> Сбросить тестовые данные
        </button>
        
        <button class="btn" onclick="exportDatabase()">
            <i class="fas fa-download"></i> Экспорт данных
        </button>
    </div>
</div>

<script>
// Добавление нового матча
document.getElementById('addMatchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const matchData = {
        team1: document.getElementById('team1').value,
        team2: document.getElementById('team2').value,
        venue: document.getElementById('venue').value,
        format: document.getElementById('format').value,
        status: document.getElementById('status').value
    };
    
    try {
        const response = await fetch('/api/match', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(matchData)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('Матч успешно добавлен!');
            location.reload();
        } else {
            alert('Ошибка: ' + result.error);
        }
    } catch (error) {
        alert('Ошибка при добавлении матча: ' + error);
    }
});

// Удаление матча
async function deleteMatch(matchId) {
    if (!confirm('Вы уверены, что хотите удалить этот матч?')) return;
    
    try {
        const response = await fetch(`/api/match/${matchId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('Матч успешно удален!');
            location.reload();
        } else {
            alert('Ошибка: ' + result.error);
        }
    } catch (error) {
        alert('Ошибка при удалении матча: ' + error);
    }
}

// Редактирование матча
function editMatch(matchId) {
    const newStatus = prompt('Введите новый статус матча (Scheduled/Live/Finished):');
    if (!newStatus) return;
    
    fetch(`/api/match/${matchId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            alert('Статус матча обновлен!');
            location.reload();
        } else {
            alert('Ошибка: ' + result.error);
        }
    })
    .catch(error => alert('Ошибка: ' + error));
}

// Веб-скрапинг матчей
async function scrapeMatches() {
    if (!confirm('Загрузить актуальные матчи с помощью веб-скрапинга?')) return;
    
    try {
        const response = await fetch('/api/scrape/matches');
        const result = await response.json();
        
        if (result.status === 'success') {
            alert(`Добавлено ${result.matches_added} новых матчей!\nВсего матчей в базе: ${result.total_matches}`);
            location.reload();
        } else {
            alert('Ошибка: ' + result.error);
        }
    } catch (error) {
        alert('Ошибка при скрапинге: ' + error);
    }
}

// Сброс тестовых данных
async function resetDatabase() {
    if (!confirm('ВНИМАНИЕ: Это удалит все данные и восстановит тестовые. Продолжить?')) return;
    
    try {
        // Здесь можно добавить API для сброса БД
        alert('Функция сброса БД будет реализована в следующих версиях');
    } catch (error) {
        alert('Ошибка: ' + error);
    }
}

// Экспорт данных
async function exportDatabase() {
    try {
        // Собираем данные из API
        const [matches, players, history] = await Promise.all([
            fetch('/api/matches').then(r => r.json()),
            fetch('/api/players').then(r => r.json()),
            fetch('/api/points/history').then(r => r.json())
        ]);
        
        const exportData = {
            export_date: new Date().toISOString(),
            matches: matches,
            players: players,
            points_history: history
        };
        
        // Создаем и скачиваем JSON файл
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `cricket_data_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        alert('Данные успешно экспортированы в JSON файл!');
    } catch (error) {
        alert('Ошибка при экспорте данных: ' + error);
    }
}
</script>

<style>
.admin-sections {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
    margin: 30px 0;
}

.admin-section {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.form-container {
    margin-bottom: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 5px;
}

.action-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.btn-edit {
    background: #61affe;
    margin-right: 5px;
}

.btn-delete {
    background: #f93e3e;
}

.badge-Scheduled { background: #fca130; }
.badge-Live { background: #49cc90; }
.badge-Finished { background: #61affe; }
</style>
{% endblock %}
