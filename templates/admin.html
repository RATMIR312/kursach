{% extends "base.html" %}

{% block title %}Админ - Cricket Scores API{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-cog"></i> Управление системой</h1>
    <p>Панель управления скрапингом данных</p>
</div>

<div class="admin-content">
    <div class="admin-card">
        <h2><i class="fas fa-info-circle"></i> Информация о системе</h2>
        <div class="system-info">
            <p><strong>Источник данных:</strong> Cricbuzz.com</p>
            <p><strong>Последнее обновление:</strong> 
                {% if last_update %}
                    {{ last_update.strftime('%d.%m.%Y %H:%M') }}
                {% else %}
                    Никогда
                {% endif %}
            </p>
            <p><strong>Статус:</strong> 
                {% if is_scraping %}
                    <span class="status-badge status-live">Скрапинг выполняется</span>
                {% else %}
                    <span class="status-badge status-idle">Ожидание</span>
                {% endif %}
            </p>
        </div>
    </div>

    <div class="admin-card">
        <h2><i class="fas fa-chart-bar"></i> Статистика базы данных</h2>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-label">Команд</div>
                <div class="stat-value">{{ stats.teams or 0 }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Игроков</div>
                <div class="stat-value">{{ stats.players or 0 }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Матчей</div>
                <div class="stat-value">{{ stats.matches or 0 }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Live</div>
                <div class="stat-value">{{ stats.live or 0 }}</div>
            </div>
        </div>
    </div>

    <div class="admin-card">
        <h2><i class="fas fa-sync-alt"></i> Управление скрапингом</h2>
        
        <div class="control-buttons">
            <button id="startScraping" class="btn btn-primary" {% if is_scraping %}disabled{% endif %}>
                <i class="fas fa-play"></i> Запустить скрапинг
            </button>
            
            <button id="checkStatus" class="btn btn-secondary">
                <i class="fas fa-refresh"></i> Обновить статус
            </button>
        </div>
        
        <div class="scraping-status">
            <h3>Статус:</h3>
            <div id="statusMessage">
                {% if is_scraping %}
                    <div class="status-indicator">
                        <div class="status-dot loading"></div>
                        <span>Выполняется скрапинг...</span>
                    </div>
                {% else %}
                    <div class="status-indicator">
                        <div class="status-dot idle"></div>
                        <span>Готов к работе</span>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="admin-card">
        <h2><i class="fas fa-tools"></i> Быстрые действия</h2>
        <div class="quick-actions">
            <button class="btn btn-small" onclick="window.location.reload()">
                <i class="fas fa-redo"></i> Обновить страницу
            </button>
            <button class="btn btn-small" onclick="window.open('/api/v1/health', '_blank')">
                <i class="fas fa-heartbeat"></i> Проверить API
            </button>
            <button class="btn btn-small" onclick="window.open('/api-docs', '_blank')">
                <i class="fas fa-book"></i> Документация
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('startScraping');
    const checkBtn = document.getElementById('checkStatus');
    const statusMsg = document.getElementById('statusMessage');
    
    function updateStatus() {
        fetch('/api/v1/admin/status')
            .then(r => r.json())
            .then(data => {
                let html = '';
                
                if (data.scraping) {
                    html = `
                        <div class="status-indicator">
                            <div class="status-dot loading"></div>
                            <span>Выполняется скрапинг...</span>
                        </div>
                    `;
                    startBtn.disabled = true;
                } else {
                    html = `
                        <div class="status-indicator">
                            <div class="status-dot idle"></div>
                            <span>Готов к работе</span>
                        </div>
                        <p><strong>Данные:</strong> ${data.teams_count} команд, ${data.players_count} игроков, ${data.matches_count} матчей</p>
                        <p><strong>Обновлено:</strong> ${data.last_update ? new Date(data.last_update).toLocaleString() : 'Никогда'}</p>
                    `;
                    startBtn.disabled = false;
                }
                
                statusMsg.innerHTML = html;
            })
            .catch(() => {
                statusMsg.innerHTML = `
                    <div class="status-indicator">
                        <div class="status-dot error"></div>
                        <span>Ошибка подключения</span>
                    </div>
                `;
            });
    }
    
    // Кнопка запуска
    startBtn.addEventListener('click', function() {
        if (this.disabled) return;
        
        fetch('/api/v1/admin/update', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                updateStatus();
            })
            .catch(() => alert('Ошибка сервера'));
    });
    
    // Кнопка обновления статуса
    checkBtn.addEventListener('click', updateStatus);
    
    // Автообновление каждые 10 секунд
    setInterval(updateStatus, 10000);
});
</script>

<style>
.admin-content {
    max-width: 800px;
    margin: 0 auto;
}

.admin-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin: 20px 0;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
}

.stat-label {
    font-size: 14px;
    color: #666;
    margin-bottom: 5px;
}

.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #2c3e50;
}

.control-buttons {
    display: flex;
    gap: 10px;
    margin: 20px 0;
}

.scraping-status {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.status-dot.loading {
    background: #f39c12;
    animation: pulse 1.5s infinite;
}

.status-dot.idle {
    background: #27ae60;
}

.status-dot.error {
    background: #e74c3c;
}

.status-badge {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}

.status-badge.status-live {
    background: #e74c3c;
    color: white;
}

.status-badge.status-idle {
    background: #27ae60;
    color: white;
}

.quick-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
</style>
{% endblock %}
